<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgroGestão - Login</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="manifest" href="/manifest.json">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="login-body">

<div class="login-wrapper">
    <div class="card login-card">
        <header class="login-header">
            <div class="logo-wrapper">
                <img src="/static/logo.png" alt="Logo AgroGestão" class="app-logo">
            </div>
            <h1>AgroGestão</h1>
            <p>Coleta de Dados Inteligente</p>
        </header>

        <div class="connection-status">
            <span class="badge" id="status-conexao"><i class="fas fa-circle"></i> Verificando...</span>
        </div>

        <form id="formLogin" class="login-form">
            <div class="input-group">
                <div class="input-field">
                    <i class="fas fa-user"></i>
                    <input type="text" id="usuario" placeholder="Usuário" required autocomplete="username">
                </div>
            </div>

            <div class="input-group">
                <div class="input-field">
                    <i class="fas fa-lock"></i>
                    <input type="password" id="senha" placeholder="Senha" required autocomplete="current-password">
                </div>
            </div>

            <button type="button" class="btn-login" onclick="autenticar()">
                <span>ENTRAR</span>
                <i class="fas fa-arrow-right"></i>
            </button>
        </form>

        <div id="status" class="status-msg"></div>
        
        <footer class="login-footer">
            <p>Sistema Campo Cargnin v2.5</p>
            <small><i class="fas fa-shield-alt"></i> Acesso Seguro</small>
        </footer>
    </div>
</div>

<script src="/static/js/db.js"></script> <script src="/static/js/app.js"></script>

<script>
    // Registro do Service Worker
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw.js');
    }

    // Função de autenticação corrigida para usar o servidor atual
    async function autenticar() {
        const user = document.getElementById('usuario').value;
        const pass = document.getElementById('senha').value;
        const status = document.getElementById('status');

        try {
            // Usamos apenas '/auth' para que o Ngrok funcione corretamente
            const response = await fetch('/auth', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ usuario: user, senha: pass })
            });

            if (response.ok) {
                status.innerText = "✅ Acesso concedido!";
                status.className = "status-msg status-sucesso";
                setTimeout(() => { window.location.href = "/menu"; }, 500);
            } else {
                status.innerText = "❌ Usuário ou senha incorretos";
                status.className = "status-msg status-erro";
            }
        } catch (err) {
            status.innerText = "❌ Erro de conexão com o servidor";
            status.className = "status-msg status-erro";
        }
    }

    function atualizarBadgeLogin() {
        const badge = document.getElementById('status-conexao');
        if (!badge) return;
        if (navigator.onLine) {
            badge.className = "badge online";
            badge.innerHTML = '<i class="fas fa-circle"></i> Online';
        } else {
            badge.className = "badge offline";
            badge.innerHTML = '<i class="fas fa-circle"></i> Offline';
        }
    }

    window.addEventListener('online', atualizarBadgeLogin);
    window.addEventListener('offline', atualizarBadgeLogin);
    document.addEventListener('DOMContentLoaded', atualizarBadgeLogin);
</script>
</body>
</html>